$(function(){var g=$("html").attr("lang");var h='getDataSourceList';var j='getSqlTraceList';var k=g=='cn'?'刷新成功':'Refresh success';var l=[];var m=10;var n=1;var o=0;var p;var q;$('#ds_monitorTable').tablesorter();$('#sql_monitorTable').tablesorter();$("#ds_refresh_button").click(function(){getDsListFromServer();alert(k)});$("#sql_refresh_button").click(function(){getSqlListFromServer();alert(k)});$("#ds_timer_button").click(function(){if(p!=null){clearInterval(p);p=null;var a=(g=='cn')?'启动定时':'Run Timer';$("#ds_timer_button").val(a)}else{p=setInterval(getDsListFromServer,$("#ds_refresh_interval").val());var a=(g=='cn')?'停止定时':'Stop Timer';$("#ds_timer_button").val(a)}});$("#sql_timer_button").click(function(){if(q!=null){clearInterval(q);q=null;var a=(g=='cn')?'启动定时':'Run Timer';$("#sql_timer_button").val(a)}else{q=setInterval(getSqlListFromServer,$("#sql_refresh_interval").val());var a=(g=='cn')?'停止定时':'Stop Timer';$("#sql_timer_button").val(a)}});$("#ds_refresh_interval").click(function(){if(p!=null){clearInterval(p);p=setInterval(getDsListFromServer,$("#ds_refresh_interval").val())}});$("#sql_refresh_interval").click(function(){if(q!=null){clearInterval(q);q=setInterval(getSqlListFromServer,$("#sql_refresh_interval").val())}});$("#page_size").change(function(){m=$("#page_size").val();n=1;showSqlTracePage(n)});$("#sql_first").click(function(){n=1;showSqlTracePage(n)});$("#sql_pre").click(function(){n=n-1;showSqlTracePage(n)});$("#sql_next").click(function(){n=n+1;showSqlTracePage(n)});$("#sql_last").click(function(){n=o;showSqlTracePage(n)});$('#tabs a').click(function(e){e.preventDefault();$('#tabs li').removeClass("current").removeClass("hoverItem");$(this).parent().addClass("current");$("#content div").removeClass("show");$('#'+$(this).attr('title')).addClass('show')});$('#tabs a').hover(function(){if(!$(this).parent().hasClass("current")){$(this).parent().addClass("hoverItem")}},function(){$(this).parent().removeClass("hoverItem")});function getSqlListFromServer(){$.ajax({type:'POST',url:j,dataType:'json',success:function(a){if(a.code==3){window.location.href="login.html"}else if(a.code==2){alert("Error:"+a.message)}else if(a.code==1){n=1;o=0;l=[];$("#sql_first").attr("disabled",true);$("#sql_pre").attr("disabled",true);$("#sql_next").attr("disabled",true);$("#sql_last").attr("disabled",true);$("#sql_monitorTable tr:not(:first)").remove();afterLoadSqlTraceList(a.result)}}})};function getDsListFromServer(){$.ajax({type:'POST',url:h,dataType:'json',success:function(e){console.info(e);$("#ds_monitorTable tr:not(:first)").remove();if(e){if(e.code==3){window.location.href="login.html"}else if(e.code==2){alert("Error:"+e.message)}else if(e.code==1){$.each(e.result,function(i,a){var b=a.poolMode;var c=a.poolState;if(g=='cn'){b=(b=='compete')?'竞争':'公平';if(c==0)c="未初始化";else if(c==1)c="已启动";else if(c==2)c="已关闭";else if(c==3)c="重置中"}else{if(c==0)c="uninitialized";else if(c==1)c="started";else if(c==2)c="closed";else if(c==3)c="clearing"}var d="<tr>"+"<td>"+a.dsId+"</td>"+"<td>"+b+"</td>"+"<td>"+c+"</td>"+"<td>"+a.poolMaxSize+"</td>"+"<td>"+a.idleSize+"</td>"+"<td>"+a.usingSize+"</td>"+"<td>"+a.semaphoreWaitingSize+"</td>"+"<td>"+a.transferWaitingSize+"</td>"+"</tr>";$("#ds_monitorTable").append(d)});$('#ds_monitorTable').trigger("update")}}}})};function afterLoadSqlTraceList(a){if(a){l=a;$("#total_sql").val(l.length);o=parseInt(l.length/m);if(a.length%m>0)o++;if(a.length>0)showSqlTracePage()}}function showSqlTracePage(){var a=(n-1)*m;var b=l.length;$("#sql_monitorTable tr:not(:first)").remove();if(o>1){if(n==1){$("#sql_first").attr("disabled",true);$("#sql_pre").attr("disabled",true);$("#sql_next").attr("disabled",false);$("#sql_last").attr("disabled",false)}else if(n==o){$("#sql_first").attr("disabled",false);$("#sql_pre").attr("disabled",false);$("#sql_next").attr("disabled",true);$("#sql_last").attr("disabled",true)}else{$("#sql_first").attr("disabled",false);$("#sql_pre").attr("disabled",false);$("#sql_next").attr("disabled",false);$("#sql_last").attr("disabled",false)}}var c=0;for(var i=a;i<b;i++){var d=l[i];var e="";if(d.endTimeMs>0){if(!d.successInd){e=" class='sqlExecFail'"}else if(d.slowInd){e=" class='sqlExecSlow'"}}var f="<tr "+e+">"+"<td>"+d.sql+"</td>"+"<td>"+d.dsId+"</td>"+"<td>"+d.startTime+"</td>"+"<td>"+d.endTime+"</td>"+"<td>"+d.tookTimeMs+"</td>"+"<td>"+d.successInd+"</td>"+"<td>"+d.statementType+'.'+d.methodName+"</td>"+"</tr>";$("#sql_monitorTable").append(f);if(++c>m)break}$('#sql_monitorTable').trigger("update")}getDsListFromServer();getSqlListFromServer()});