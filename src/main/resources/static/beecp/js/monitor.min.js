var dsURL='getDataSourceList';var sqlURL='getSqlTraceList';var clearURL='clearPool';var interruptURL='interruptPool';var language=$("html").attr("lang");function poolClear(b){$.ajax({type:'POST',url:clearURL,dataType:'json',contentType:'application/json',data:JSON.stringify({'dsId':b}),success:function(a){if(a.code==1){$('#ds_refresh_button').trigger("click")}}})}function poolInterrupt(b){$.ajax({type:'POST',url:interruptURL,dataType:'json',contentType:'application/json',data:JSON.stringify({'dsId':b}),success:function(a){$('#ds_refresh_button').trigger("click")}})}$(function(){var m=language=='cn'?'刷新成功':'Refresh success';var n=[];var o=10;var p=1;var q=0;var r;var s;$('#ds_monitorTable').tablesorter();$('#sql_monitorTable').tablesorter();$("#ds_refresh_button").click(function(){getDsListFromServer();alert(m)});$("#sql_refresh_button").click(function(){getSqlListFromServer();alert(m)});$("#ds_timer_button").click(function(){if(r!=null){clearInterval(r);r=null;var a=(language=='cn')?'启动定时':'Run Timer';$("#ds_timer_button").val(a)}else{r=setInterval(getDsListFromServer,$("#ds_refresh_interval").val());var a=(language=='cn')?'停止定时':'Stop Timer';$("#ds_timer_button").val(a)}});$("#sql_timer_button").click(function(){if(s!=null){clearInterval(s);s=null;var a=(language=='cn')?'启动定时':'Run Timer';$("#sql_timer_button").val(a)}else{s=setInterval(getSqlListFromServer,$("#sql_refresh_interval").val());var a=(language=='cn')?'停止定时':'Stop Timer';$("#sql_timer_button").val(a)}});$("#ds_refresh_interval").click(function(){if(r!=null){clearInterval(r);r=setInterval(getDsListFromServer,$("#ds_refresh_interval").val())}});$("#sql_refresh_interval").click(function(){if(s!=null){clearInterval(s);s=setInterval(getSqlListFromServer,$("#sql_refresh_interval").val())}});$("#page_size").change(function(){o=$("#page_size").val();p=1;showSqlTracePage(p)});$("#sql_first").click(function(){p=1;showSqlTracePage(p)});$("#sql_pre").click(function(){p=p-1;showSqlTracePage(p)});$("#sql_next").click(function(){p=p+1;showSqlTracePage(p)});$("#sql_last").click(function(){p=q;showSqlTracePage(p)});$('#tabs a').click(function(e){e.preventDefault();$('#tabs li').removeClass("current").removeClass("hoverItem");$(this).parent().addClass("current");$("#content div").removeClass("show");$('#'+$(this).attr('title')).addClass('show')});$('#tabs a').hover(function(){if(!$(this).parent().hasClass("current")){$(this).parent().addClass("hoverItem")}},function(){$(this).parent().removeClass("hoverItem")});function getSqlListFromServer(){$.ajax({type:'POST',url:sqlURL,dataType:'json',success:function(a){if(a.code==3){window.location.href="login.html"}else if(a.code==2){alert("Error:"+a.message)}else if(a.code==1){p=1;q=0;n=[];$("#sql_first").attr("disabled",true);$("#sql_pre").attr("disabled",true);$("#sql_next").attr("disabled",true);$("#sql_last").attr("disabled",true);$("#sql_monitorTable tr:not(:first)").remove();afterLoadSqlTraceList(a.result)}}})};function getDsListFromServer(){$.ajax({type:'POST',url:dsURL,dataType:'json',success:function(l){console.info(l);$("#ds_monitorTable tr:not(:first)").remove();if(l){if(l.code==3){window.location.href="login.html"}else if(l.code==2){alert("Error:"+l.message)}else if(l.code==1){$.each(l.result,function(i,a){var b=a.poolMode;var c=a.poolState;var d=a.creatingTime;var e=a.creatingTimeout;var f;var g;var h;var j;if(language=='cn'){h='清理';j='中断';b=(b=='compete')?'竞争':'公平';if(c==0)c="未初始化";else if(c==1)c="启动中";else if(c==2)c="已启动";else if(c==3)c="关闭中";else if(c==4)c="已关闭";else if(c==5)c="清理中";if(d!=0){f='是';g=createTimeout?'已超时':'未超时'}else{f='N/A';g='N/A'}}else{h='Clear';j='Interrupt';if(c==0)c="uninitialized";else if(c==1)c="starting";else if(c==2)c="ready";else if(c==3)c="closing";else if(c==4)c="closed";else if(c==5)c="clearing";if(d!=0){f='Yes';g=createTimeout?'Yes':'N/A'}else{f='N/A';g='N/A'}}var k="<tr>"+"<td>"+a.dsId+"</td>"+"<td>"+b+"</td>"+"<td>"+c+"</td>"+"<td>"+a.poolMaxSize+"</td>"+"<td>"+a.idleSize+"</td>"+"<td>"+a.usingSize+"</td>"+"<td>"+a.semaphoreWaitingSize+"</td>"+"<td>"+a.transferWaitingSize+"</td>"+"<td>"+f+"</td>"+"<td>"+g+"</td>"+"<td><input id='pool_clear_button' onclick='poolClear(\""+a.dsId+"\")' type='button' value='"+h+"'/>";if(g!='N/A')k=k+"<input id='pool_interrupt_button' onclick='poolInterrupt(\""+a.dsId+"\")' type='button' value='"+j+"'/>";k=k+"</td></tr>";$("#ds_monitorTable").append(k)});$('#ds_monitorTable').trigger("update")}}}})};function afterLoadSqlTraceList(a){if(a){n=a;$("#total_sql").val(n.length);q=parseInt(n.length/o);if(a.length%o>0)q++;if(a.length>0)showSqlTracePage()}}function showSqlTracePage(){var a=(p-1)*o;var b=n.length;$("#sql_monitorTable tr:not(:first)").remove();if(q>1){if(p==1){$("#sql_first").attr("disabled",true);$("#sql_pre").attr("disabled",true);$("#sql_next").attr("disabled",false);$("#sql_last").attr("disabled",false)}else if(p==q){$("#sql_first").attr("disabled",false);$("#sql_pre").attr("disabled",false);$("#sql_next").attr("disabled",true);$("#sql_last").attr("disabled",true)}else{$("#sql_first").attr("disabled",false);$("#sql_pre").attr("disabled",false);$("#sql_next").attr("disabled",false);$("#sql_last").attr("disabled",false)}}var c=0;for(var i=a;i<b;i++){var d=n[i];var e="";if(d.endTimeMs>0){if(!d.successInd){e=" class='sqlExecFail'"}else if(d.slowInd){e=" class='sqlExecSlow'"}}var f="<tr "+e+">"+"<td>"+d.sql+"</td>"+"<td>"+d.dsId+"</td>"+"<td>"+d.startTime+"</td>"+"<td>"+d.endTime+"</td>"+"<td>"+d.tookTimeMs+"</td>"+"<td>"+d.successInd+"</td>"+"<td>"+d.statementType+'.'+d.methodName+"</td>"+"</tr>";$("#sql_monitorTable").append(f);if(++c>o)break}$('#sql_monitorTable').trigger("update")}getDsListFromServer();getSqlListFromServer()});